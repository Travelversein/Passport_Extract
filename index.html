<!DOCTYPE html>
<html lang="en" class="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Information Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Theme script is kept for toggling, but defaults to dark now.
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage))) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        /* --- NEW UI STYLE DEFINITIONS --- */
        :root {
            /* Light theme colors (kept for toggle functionality) */
            --bg-primary: #ffffff;
            --bg-secondary: #f4f4f4;
            --bg-tertiary: #ffffff;
            --text-primary: #000000;
            --text-secondary: #666666;
            --border-color: #e5e5e5;
            --accent-color: #000000;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --btn-primary-bg: #000000;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #e5e5e5;
            --btn-secondary-text: #000000;
        }

        .dark {
            /* Dark theme inspired by narrativeco.in */
            --bg-primary: #0a0a0a;
            --bg-secondary: #000000;
            --bg-tertiary: #0a0a0a;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --border-color: #222222;
            --accent-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --btn-primary-bg: #ffffff;
            --btn-primary-text: #000000;
            --btn-secondary-bg: #1f1f1f;
            --btn-secondary-text: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Main panels with sharp corners */
        .main-panel {
            background-color: var(--bg-tertiary);
            border-radius: 0; /* Sharp corners */
            border: 1px solid var(--border-color);
            box-shadow: none; /* Removed shadow for a flatter look */
            transition: background-color 0.3s, border-color 0.3s;
        }

        /* --- REFINED TYPOGRAPHY HIERARCHY --- */
        .title-main {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 4rem; /* Main title size */
            letter-spacing: 2px;
            text-transform: uppercase;
            line-height: 1;
        }
        .title-section { 
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem; /* Reduced section title size */
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--text-primary); 
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color); /* Separator line */
        }
        h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: 1.5rem;
        }
        p { color: var(--text-secondary); }

        /* Redesigned buttons */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 12px 20px;
            border-radius: 0; /* Sharp corners */
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* Outlined primary button style */
        .btn-primary {
            background-color: transparent;
            color: var(--text-primary);
            border-color: var(--text-primary);
        }
        .dark .btn-primary:hover:not(:disabled) { background-color: var(--text-primary); color: var(--bg-primary); }
        .light .btn-primary:hover:not(:disabled) { background-color: var(--text-primary); color: var(--bg-primary); }

        /* Solid secondary button style */
        .btn-secondary { 
            background-color: var(--btn-secondary-bg); 
            color: var(--btn-secondary-text);
            border-color: var(--btn-secondary-bg);
        }
        .btn-secondary:hover:not(:disabled) { filter: brightness(1.2); }
        .dark .btn-secondary:hover:not(:disabled) { filter: brightness(1.2); }

        /* Redesigned form inputs */
        .form-input, .form-select {
            width: 100%;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 10px 14px;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        .dark .form-input, .dark .form-select { background-color: #000; }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            background-color: var(--bg-tertiary);
            box-shadow: none;
        }
        
        .form-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Improved styling for date inputs to ensure calendar icon is visible */
        .dark input[type="date"] { color-scheme: dark; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: brightness(0.8);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8);
        }


        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .active-dashboard-filter { background-color: var(--btn-secondary-bg); }
        
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast-in { animation: slideInRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .toast-out { animation: slideOutRight 0.5s cubic-bezier(0.5, 0, 0.75, 0) forwards; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-12">
            <div class="text-left">
                <h1 class="title-main">Travelverse Passport Extractor</h1>
                <p class="max-w-2xl mt-4">Upload a passport image to automatically extract and save traveler information.</p>
            </div>
             <div class="flex items-center gap-2">
                <button id="theme-toggle" type="button" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50 focus:outline-none transition-colors">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm7.536 2.464a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414z"></path></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="main-panel p-6">
                <h2 class="title-section">Upload Passport</h2>
                <div id="upload-container" class="border-2 border-dashed border-[var(--border-color)] p-8 text-center cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors">
                    <input type="file" id="passport-upload" class="hidden" accept=".pdf,.png,.jpeg,.jpg">
                    <svg class="mx-auto h-12 w-12 text-[var(--text-secondary)]" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <p class="mt-2 text-sm"><span class="font-medium text-[var(--accent-color)]">Click to upload</span> or drag and drop</p>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">PNG, JPG, JPEG, or PDF</p>
                </div>
                
                 <div id="loading-spinner" class="mt-6 hidden text-center"><div class="loader mx-auto"></div><p class="mt-4">Extracting information, please wait...</p></div>

                <div id="comparison-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 items-start">
                    <div><img id="image-preview" src="#" alt="Passport Preview" class="w-full border border-[var(--border-color)]"></div>
                    <div>
                        <h3>Extracted Information</h3>
                        <div id="extracted-data" class="space-y-4"></div>
                        <div class="mt-4">
                            <label for="tags-input" class="form-label mb-1 block">Tags (comma-separated)</label>
                            <input type="text" id="tags-input" placeholder="e.g. Family Trip, VIP" class="form-input text-sm">
                        </div>
                        <button id="save-button" class="btn btn-primary mt-6 w-full" disabled>
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75H6.912a2.25 2.25 0 00-2.15 1.588L2.35 13.177a2.25 2.25 0 00-.1.661V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338A2.25 2.25 0 0017.088 3.75H15M12 3.75v9" /></svg>
                            <span id="save-button-text">Save Information</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-panel p-6">
                <h2 class="title-section">Saved Records</h2>
                <div class="flex items-center space-x-2 md:space-x-4 mb-6 text-center">
                    <div id="dashboard-total" class="flex-1 p-2 cursor-pointer transition-colors"><p class="text-3xl font-bold font-sans" id="total-records">0</p><p class="text-xs uppercase tracking-wider">Total</p></div>
                    <div id="dashboard-expiring-soon" class="flex-1 p-2 cursor-pointer transition-colors"><p class="text-3xl font-bold font-sans text-yellow-500" id="expiring-soon">0</p><p class="text-xs uppercase tracking-wider">Expiring &lt; 1 Yr</p></div>
                    <div id="dashboard-expiring-6m" class="flex-1 p-2 cursor-pointer transition-colors"><p class="text-3xl font-bold font-sans text-red-500" id="expiring-6m">0</p><p class="text-xs uppercase tracking-wider">Expiring &lt; 6 Mo</p></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div class="relative"><input type="text" id="search-bar" placeholder="Search..." class="form-input pl-10"><svg class="w-5 h-5 text-[var(--text-secondary)] absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="sort-by" class="form-select"><option value="createdAt">Sort: Date</option><option value="LastName">Sort: Name</option><option value="DateofExpiry">Sort: Expiry</option></select>
                        <select id="filter-expiry" class="form-select">
                            <option value="all">Filter: All</option>
                            <option value="1y">Expiring &lt; 1yr</option>
                            <option value="6m">Expiring &lt; 6mo</option>
                        </select>
                    </div>
                </div>
                 <button id="export-csv" class="btn btn-secondary w-full mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v4.59L7.3 9.24a.75.75 0 00-1.1 1.02l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75z" clip-rule="evenodd" /></svg><span>Export All to CSV</span></button>
                <div id="history-container" class="space-y-4 max-h-[550px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 bg-[var(--bg-tertiary)] border-[var(--border-color)]">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <h3 class="text-lg leading-6 font-medium mt-2">Delete Record</h3>
                <div class="mt-2 px-7 py-3"><p class="text-sm">Are you sure? This action cannot be undone.</p></div>
                <div class="flex gap-2 items-center px-4 py-3">
                    <button id="cancel-delete-btn" class="btn btn-secondary w-full">Cancel</button>
                    <button id="confirm-delete-btn" class="btn btn-primary w-full bg-red-600 hover:bg-red-700 border-red-600 hover:border-red-700">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <div id="travel-history-modal" class="fixed inset-0 bg-black bg-opacity-80  h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-[var(--bg-tertiary)] border border-[var(--border-color)] p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="title-section !mb-0 !pb-0 !border-none" id="travel-history-title">Travel History</h2>
                <button id="close-travel-history-modal" class="text-2xl text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors">&times;</button>
            </div>

            <div class="max-h-[300px] overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="border-b border-[var(--border-color)]">
                        <tr>
                            <th class="p-2 form-label">Country</th>
                            <th class="p-2 form-label">Date of Entry</th>
                            <th class="p-2 form-label">Date of Exit</th>
                            <th class="p-2 form-label"># of Days</th>
                            <th class="p-2 form-label">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="travel-history-table-body">
                        </tbody>
                </table>
            </div>
            
            <div class="add-entry-form space-y-3 border-t border-[var(--border-color)] pt-4">
                <h3 class="!text-lg">Add New Entry</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <select id="th-country" class="form-input"></select>
                    <input type="date" id="th-entry-date" class="form-input">
                    <input type="date" id="th-exit-date" class="form-input">
                    <button id="th-add-btn" class="btn btn-secondary">Add</button>
                </div>
            </div>
            
            <div class="flex justify-end pt-4">
                <button id="th-save-btn" class="btn btn-primary">Save and Close</button>
            </div>
        </div>
    </div>

    <footer class="text-center py-8 text-sm text-[var(--text-secondary)]">
        <p>Intelligent travel system I Powered by Travelverse</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyCtEzszro3KuPP__512HWj_8T16ElZUOAU",
          authDomain: "passport-technology-8ecfa.firebaseapp.com",
          projectId: "passport-technology-8ecfa",
          storageBucket: "passport-technology-8ecfa.firebasestorage.app",
          messagingSenderId: "834455244022",
          appId: "1:834455244022:web:ad7ba60cb7e1e38106b0d7",
          measurementId: "G-2RRTNRFWLF"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let allPassports = [];
        let dataListenerUnsubscribe = null;
        let currentEditingPassportId = null; 

        // --- Data Definitions ---
        const passportFields = [
            { key: "givenName", label: "First Name" }, { key: "surname", label: "Last Name" },
            { key: "passportNo", label: "Passport No." }, { key: "issuingCountryCode", label: "Issuing Country Code" },
            { key: "nationality", label: "Nationality" }, { key: "sex", label: "Sex" },
            { key: "dateOfBirth", label: "Date of Birth" }, { key: "placeOfBirth", label: "Place of Birth" },
            { key: "dateOfIssue", label: "Date of Issue" }, { key: "dateOfExpiry", label: "Date of Expiry" }
        ];

        const countryList = ["Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo, Democratic Republic of the","Congo, Republic of the","Costa Rica","Cote d'Ivoire","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Kosovo","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar (Burma)","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Korea","North Macedonia","Norway","Oman","Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Korea","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"];

        // --- Helper Functions ---
        function formatDateForDisplay(isoDate) {
            if (!isoDate || isoDate === "N/A" || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return isoDate;
            const [y, m, d] = isoDate.split('-');
            return `${d}-${m}-${y}`;
        }

        function parseDateFromDisplay(displayDate) {
            if (!displayDate || displayDate === "N/A" || !/^\d{2}-\d{2}-\d{4}$/.test(displayDate)) return displayDate;
            const [d, m, y] = displayDate.split('-');
            return `${y}-${m}-${d}`;
        }

        function calculateAge(isoDate) {
            if (!isoDate || isoDate === "N/A" || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return "N/A";
            const birthDate = new Date(isoDate);
            if (isNaN(birthDate.getTime())) return "N/A";
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDifference = today.getMonth() - birthDate.getMonth();
            if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age >= 0 ? age : "N/A";
        }

        function calculateDays(startDateStr, endDateStr) {
            if (!startDateStr || !endDateStr) return 'N/A';
            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            if (isNaN(start.getTime()) || isNaN(end.getTime()) || end < start) return 'N/A';
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // Inclusive
            return diffDays;
        }
        
        // --- DOM Elements ---
        const dom = { 
            uploadContainer: document.getElementById('upload-container'), passportUpload: document.getElementById('passport-upload'), loadingSpinner: document.getElementById('loading-spinner'), 
            historyContainer: document.getElementById('history-container'), searchBar: document.getElementById('search-bar'), tagsInput: document.getElementById('tags-input'), 
            exportCsvButton: document.getElementById('export-csv'), sortByEl: document.getElementById('sort-by'), filterExpiryEl: document.getElementById('filter-expiry'), 
            deleteModal: document.getElementById('delete-modal'), confirmDeleteBtn: document.getElementById('confirm-delete-btn'), cancelDeleteBtn: document.getElementById('cancel-delete-btn'), 
            themeToggle: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon'), 
            comparisonView: document.getElementById('comparison-view'), imagePreview: document.getElementById('image-preview'), extractedDataEl: document.getElementById('extracted-data'), 
            saveButton: document.getElementById('save-button'),
            dashboardTotal: document.getElementById('dashboard-total'),
            dashboardExpiringSoon: document.getElementById('dashboard-expiring-soon'),
            dashboardExpiring6m: document.getElementById('dashboard-expiring-6m'),
            travelHistoryModal: document.getElementById('travel-history-modal'),
            closeTravelHistoryModalBtn: document.getElementById('close-travel-history-modal'),
            travelHistoryTitle: document.getElementById('travel-history-title'),
            travelHistoryTableBody: document.getElementById('travel-history-table-body'),
            thCountryInput: document.getElementById('th-country'),
            thEntryDateInput: document.getElementById('th-entry-date'),
            thExitDateInput: document.getElementById('th-exit-date'),
            thAddBtn: document.getElementById('th-add-btn'),
            thSaveBtn: document.getElementById('th-save-btn')
        };
        
        // --- App Initialization ---
        function startApp() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    dom.saveButton.disabled = false;
                    dom.saveButton.querySelector('span').textContent = 'Save Information';
                    if (dataListenerUnsubscribe) dataListenerUnsubscribe();
                    loadHistory();
                } else {
                    dom.saveButton.querySelector('span').textContent = 'Connecting...';
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        dom.saveButton.querySelector('span').textContent = 'Auth Failed';
                        showToast('Authentication failed. Please check Firebase settings.', 'error');
                    });
                }
            });
        }
        
        // --- Event Listeners ---
        dom.uploadContainer.addEventListener('click', () => dom.passportUpload.click());
        ['dragover', 'dragleave', 'drop'].forEach(evt => dom.uploadContainer.addEventListener(evt, e => { e.preventDefault(); dom.uploadContainer.classList.toggle('!bg-gray-50', evt === 'dragover'); if (evt === 'drop' && e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); }));
        dom.passportUpload.onchange = e => { if (e.target.files.length) handleFile(e.target.files[0]); };
        dom.saveButton.onclick = savePassportData;
        [dom.searchBar, dom.sortByEl, dom.filterExpiryEl].forEach(el => el.oninput = renderHistoryCards);
        dom.exportCsvButton.onclick = exportToCSV;
        dom.cancelDeleteBtn.onclick = () => dom.deleteModal.classList.add('hidden');
        dom.themeToggle.onclick = () => { localStorage.setItem('theme', document.documentElement.classList.toggle('dark') ? 'dark' : 'light'); updateThemeIcons(); };
        dom.dashboardTotal.onclick = () => { dom.filterExpiryEl.value = 'all'; dom.searchBar.value = ''; renderHistoryCards(); };
        dom.dashboardExpiringSoon.onclick = () => { dom.filterExpiryEl.value = '1y'; renderHistoryCards(); };
        dom.dashboardExpiring6m.onclick = () => { dom.filterExpiryEl.value = '6m'; renderHistoryCards(); };
        dom.closeTravelHistoryModalBtn.onclick = () => dom.travelHistoryModal.classList.add('hidden');
        dom.thAddBtn.onclick = addNewTravelHistoryRow;
        dom.thSaveBtn.onclick = saveTravelHistory;

        function populateCountryDropdown() {
            const selectElement = dom.thCountryInput;
            if (selectElement) {
                selectElement.innerHTML = '<option value="" disabled selected>Select a country</option>';
                countryList.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country;
                    selectElement.appendChild(option);
                });
            }
        }

        startApp();
        updateThemeIcons();
        populateCountryDropdown();

        // --- UI & Theme ---
        function updateThemeIcons() { dom.darkIcon.classList.toggle('hidden', !document.documentElement.classList.contains('dark')); dom.lightIcon.classList.toggle('hidden', document.documentElement.classList.contains('dark')); }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `p-4 text-white ${colors} toast-in`;
            toast.style.borderRadius = "0px";
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.replace('toast-in', 'toast-out'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

        // --- File Handling and OCR ---
        async function handleFile(file) {
            resetUI(); 
            dom.uploadContainer.classList.add('hidden');
            let currentImageBase64Url;
            if (file.type === 'application/pdf') {
                dom.loadingSpinner.classList.remove('hidden');
                const pdfData = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                currentImageBase64Url = canvas.toDataURL('image/jpeg');
            } else {
                currentImageBase64Url = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }
            dom.imagePreview.src = currentImageBase64Url;
            const base64Data = currentImageBase64Url.split(',')[1];
            extractData(base64Data, file.type.includes('pdf') ? 'image/jpeg' : file.type);
        }
        
        async function extractData(base64ImageData, mimeType) {
            dom.loadingSpinner.classList.remove('hidden');
            const apiKey=firebaseConfig.apiKey;
            const model="gemini-1.5-flash-latest";
            const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const sysPrompt = `You are an expert OCR system for passports. Extract the following information and return it as a valid JSON object with camelCase keys: ${passportFields.map(f => f.key).join(', ')}. Crucially, all dates must be formatted as YYYY-MM-DD. If a field is not present, use "N/A".`;
            const payload={contents:[{parts:[{text:"Extract passport info."}, {inlineData:{mimeType, data:base64ImageData}}]}], systemInstruction:{parts:[{text:sysPrompt}]}, generationConfig:{responseMimeType:"application/json"}};
            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    const extractedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayExtractedData(extractedJson);
                } else { 
                    console.error("No data in Gemini response:", result); 
                    displayError("Failed to extract info."); 
                }
            } catch (e) { 
                console.error("Gemini API error:", e); 
                displayError("Error processing image."); 
            } finally { 
                dom.loadingSpinner.classList.add('hidden'); 
            }
        }

        function displayExtractedData(data) {
            dom.extractedDataEl.innerHTML = '';
            checkAndDisplayExpiryWarning(data.dateOfExpiry, dom.extractedDataEl);
            
            passportFields.forEach(field => {
                let value = data[field.key] || "N/A";
                if (field.key.toLowerCase().includes("date")) {
                    value = formatDateForDisplay(value);
                }
                const div = document.createElement('div');
                div.innerHTML = `<label class="form-label mb-1 block">${field.label}</label><input type="text" class="form-input text-sm" value="${value}" data-key="${field.key}">`;
                dom.extractedDataEl.appendChild(div);
            });
            
            const age = calculateAge(data.dateOfBirth);
            const ageDiv = document.createElement('div');
            ageDiv.innerHTML = `<label class="form-label mb-1 block">Current Age</label><div class="text-sm text-[var(--text-primary)] mt-1 h-[42px] flex items-center">${age}</div>`;
            dom.extractedDataEl.appendChild(ageDiv);
            dom.comparisonView.classList.remove('hidden');
        }

        // --- Firestore Database Operations ---
        async function savePassportData() {
            if (!userId) { showToast("Cannot save: Connection not ready.", "error"); return; }
            const dataToSave = { createdAt: new Date().toISOString(), imageData: dom.imagePreview.src, lastUpdatedAt: new Date().toISOString() };
            
            dom.extractedDataEl.querySelectorAll('input[data-key]').forEach(i => {
                let value = i.value.trim() || "N/A";
                if (i.dataset.key.toLowerCase().includes("date")) value = parseDateFromDisplay(value);
                dataToSave[i.dataset.key] = value;
            });

            dataToSave.tags = dom.tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
            dataToSave.age = calculateAge(dataToSave.dateOfBirth);
            
            if (dataToSave.passportNo && dataToSave.passportNo !== "N/A" && allPassports.some(p => p.passportNo == dataToSave.passportNo)) {
                showToast("A passport with this number already exists.", "error");
                return;
            }
            try {
                await addDoc(collection(db, `artifacts/${firebaseConfig.projectId}/users/${userId}/passports`), dataToSave);
                showToast("Information saved successfully!");
                setTimeout(resetUI, 1000);
            } catch (e) {
                console.error("Save error:", e);
                showToast("Failed to save. Network or server issue.", "error");
            }
        }

        function loadHistory() {
            if(!userId) return;
            const q = collection(db, `artifacts/${firebaseConfig.projectId}/users/${userId}/passports`);
            dataListenerUnsubscribe = onSnapshot(q, snap => {
                allPassports = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderHistoryCards();
                updateDashboardAnalytics();
            }, (error) => console.error("Error listening to data:", error));
        }
        
        // --- Card and Modal Rendering ---
        function createHistoryCard(data) {
            const card = document.createElement('div');
            card.className = 'bg-[var(--bg-tertiary)] p-4 border border-[var(--border-color)] space-y-3 passport-card transition-all duration-300';
            card.dataset.docId = data.id;

            const status = getExpiryStatus(data.dateOfExpiry);
            const statusClasses = { Active: 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300', Soon: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300', Expired: 'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300' };
            card.innerHTML = `<div class="flex justify-between items-start"><div class="font-semibold text-base">${data.givenName || ''} ${data.surname || ''}</div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClasses[status]}">${status}</span></div>`;

            const viewContainer = document.createElement('div');
            viewContainer.className = 'view-mode';
            const age = calculateAge(data.dateOfBirth);
            viewContainer.innerHTML = `<div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">${createDetailItem('Passport No.', data.passportNo)}${createDetailItem('Nationality', data.nationality)}${createDetailItem('Place of Birth', data.placeOfBirth)}${createDetailItem('Sex', data.sex)}${createDetailItem('Date of Birth', formatDateForDisplay(data.dateOfBirth))}${createDetailItem('Current Age', age)}${createDetailItem('Date of Issue', formatDateForDisplay(data.dateOfIssue))}${createDetailItem('Date of Expiry', formatDateForDisplay(data.dateOfExpiry), (status === 'Expired' ? 'text-red-500' : status === 'Soon' ? 'text-yellow-500' : ''))}</div>`;

            if (data.tags && data.tags.length) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'mt-3 flex flex-wrap gap-1.5';
                data.tags.forEach(t => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'inline-block bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 px-2 py-0.5 rounded text-xs font-medium';
                    tagEl.textContent = t;
                    tagsContainer.appendChild(tagEl);
                });
                viewContainer.appendChild(tagsContainer);
            }
            card.appendChild(viewContainer);

            const editContainer = document.createElement('div');
            editContainer.className = 'edit-mode hidden space-y-4';
            passportFields.forEach(field => {
                let value = data[field.key] || '';
                if (field.key.toLowerCase().includes("date")) {
                    value = formatDateForDisplay(value);
                }
                editContainer.innerHTML += `<div><label class="form-label mb-1 block">${field.label}</label><input type="text" data-key="${field.key}" value="${value}" class="form-input text-sm mt-1"></div>`;
            });
            editContainer.innerHTML += `<div><label class="form-label mb-1 block">Current Age</label><input type="text" value="${age}" class="form-input text-sm mt-1" readonly style="background-color: var(--bg-primary); cursor: default;"></div>`;
            editContainer.innerHTML += `<div><label class="form-label mb-1 block">Tags</label><input type="text" data-key="tags" value="${(data.tags || []).join(', ')}" class="form-input text-sm mt-1"></div>`;
            card.appendChild(editContainer);

            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex flex-wrap gap-2 pt-4 mt-4 border-t border-[var(--border-color)]';
            const btns = { 
                preview: createButton('Preview', 'btn-secondary'), 
                edit: createButton('Edit', 'btn-secondary'), 
                del: createButton('Delete', 'btn-secondary'), 
                ai: createButton('AI Asst', 'btn-secondary'),
                travel: createButton('Travel History', 'btn-secondary'),
                save: createButton('Save', 'btn-primary hidden'), 
                cancel: createButton('Cancel', 'btn-secondary hidden') 
            };
            btnContainer.append(btns.preview, btns.edit, btns.travel, btns.ai, btns.del, btns.save, btns.cancel);
            card.appendChild(btnContainer);

            const imgContainer = document.createElement('div');
            imgContainer.className = 'hidden mt-4';
            if (data.imageData) {
                imgContainer.innerHTML = `<img src="${data.imageData}" alt="Passport Preview" class="w-full border border-[var(--border-color)]">`;
                btns.preview.onclick = () => { const isHidden = imgContainer.classList.toggle('hidden'); btns.preview.textContent = isHidden ? 'Show Preview' : 'Hide Preview'; };
            } else {
                btns.preview.disabled = true;
                btns.preview.textContent = 'No Preview';
            }
            card.appendChild(imgContainer);

            const aiContainer = document.createElement('div');
            aiContainer.className = 'hidden mt-4 pt-4 border-t border-[var(--border-color)] space-y-3';
            // ... (AI container setup remains the same)
            card.appendChild(aiContainer);

            // Button Event Listeners
            btns.edit.onclick = () => { [viewContainer, btns.edit, btns.del, btns.preview, btns.ai, btns.travel].forEach(el => el.classList.add('hidden'));[editContainer, btns.save, btns.cancel].forEach(el => el.classList.remove('hidden')); };
            btns.cancel.onclick = () => { [viewContainer, btns.edit, btns.del, btns.preview, btns.ai, btns.travel].forEach(el => el.classList.remove('hidden'));[editContainer, btns.save, btns.cancel].forEach(el => el.classList.add('hidden')); };
            btns.travel.onclick = () => openTravelHistoryModal(data);
            btns.save.onclick = async () => {
                try {
                    const updatedData = { lastUpdatedAt: new Date().toISOString() };
                    editContainer.querySelectorAll('input[data-key]').forEach(i => {
                        const key = i.dataset.key;
                        if (key === 'tags') {
                            updatedData.tags = i.value.split(',').map(t => t.trim()).filter(Boolean);
                        } else {
                            updatedData[key] = key.toLowerCase().includes("date") ? parseDateFromDisplay(i.value) : i.value;
                        }
                    });
                    updatedData.age = calculateAge(updatedData.dateOfBirth);
                    await updateDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users/${userId}/passports`, data.id), updatedData);
                    
                    btns.cancel.onclick(); // Reuse cancel logic to switch view
                    showToast('Record updated!');
                } catch (error) {
                    console.error("Update failed:", error);
                    showToast("Failed to update record.", "error");
                }
            };
            btns.del.onclick = () => {
                dom.deleteModal.classList.remove('hidden');
                dom.confirmDeleteBtn.onclick = async () => {
                    await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users/${userId}/passports`, data.id));
                    dom.deleteModal.classList.add('hidden');
                    showToast('Record deleted.', 'error');
                };
            };
            
            return card;
        }
        
        // --- Travel History Functions ---
        function openTravelHistoryModal(passportData) {
            currentEditingPassportId = passportData.id;
            dom.travelHistoryTitle.textContent = `Travel History for ${passportData.givenName || ''} ${passportData.surname || ''}`;
            dom.travelHistoryTableBody.innerHTML = '';

            if (passportData.travelHistory && passportData.travelHistory.length > 0) {
                passportData.travelHistory.forEach(entry => {
                    const row = createTravelHistoryRow(entry.country, entry.entryDate, entry.exitDate);
                    dom.travelHistoryTableBody.appendChild(row);
                });
            }
            dom.travelHistoryModal.classList.remove('hidden');
        }

        function addNewTravelHistoryRow() {
            const country = dom.thCountryInput.value;
            const entryDate = dom.thEntryDateInput.value;
            const exitDate = dom.thExitDateInput.value;

            if (!country || !entryDate || !exitDate) {
                showToast("All fields are required.", "error");
                return;
            }
            if (new Date(exitDate) < new Date(entryDate)) {
                showToast("Exit date cannot be before entry date.", "error");
                return;
            }

            const row = createTravelHistoryRow(country, entryDate, exitDate);
            dom.travelHistoryTableBody.appendChild(row);
            
            // Clear inputs
            dom.thCountryInput.selectedIndex = 0;
            dom.thEntryDateInput.value = '';
            dom.thExitDateInput.value = '';
        }

        function createTravelHistoryRow(country, entryDate, exitDate) {
            const tr = document.createElement('tr');
            tr.className = "border-b border-[var(--border-color)]";
            const days = calculateDays(entryDate, exitDate);
            
            tr.innerHTML = `
                <td class="p-2">${country}</td>
                <td class="p-2">${formatDateForDisplay(entryDate)}</td>
                <td class="p-2">${formatDateForDisplay(exitDate)}</td>
                <td class="p-2">${days}</td>
                <td class="p-2"><button class="text-red-500 delete-th-row">Delete</button></td>
            `;
            
            tr.querySelector('.delete-th-row').onclick = (e) => e.target.closest('tr').remove();
            
            // Store raw data for saving
            tr.dataset.country = country;
            tr.dataset.entryDate = entryDate;
            tr.dataset.exitDate = exitDate;
            
            return tr;
        }
        
        async function saveTravelHistory() {
            if (!currentEditingPassportId) return;

            const rows = dom.travelHistoryTableBody.querySelectorAll('tr');
            const newTravelHistory = Array.from(rows).map(row => ({
                country: row.dataset.country,
                entryDate: row.dataset.entryDate,
                exitDate: row.dataset.exitDate,
            }));

            try {
                const docRef = doc(db, `artifacts/${firebaseConfig.projectId}/users/${userId}/passports`, currentEditingPassportId);
                await updateDoc(docRef, {
                    travelHistory: newTravelHistory
                });
                showToast("Travel history updated!");
                dom.travelHistoryModal.classList.add('hidden');
                currentEditingPassportId = null;
            } catch (error) {
                console.error("Failed to save travel history:", error);
                showToast("Could not save travel history.", "error");
            }
        }


        // --- UI Helper Functions ---
        function createDetailItem(label, value, valueClass = '') { 
            return `<div><div class="form-label">${label}</div><div class="text-sm text-[var(--text-primary)] mt-1 ${valueClass}">${value || 'N/A'}</div></div>`; 
        }
        function createButton(text, className) { const btn=document.createElement('button');btn.className=`btn text-xs flex-1 ${className}`;btn.textContent=text; return btn; }
        
        function getExpiryStatus(isoDate) {
            if (!isoDate || isoDate === 'N/A') return 'Active';
            const expiryDate = new Date(isoDate);
            if (isNaN(expiryDate.getTime())) return 'Active';
            const now = new Date();
            const oneYearFromNow = new Date();
            oneYearFromNow.setFullYear(now.getFullYear() + 1);
            if (expiryDate < now) return 'Expired';
            if (expiryDate < oneYearFromNow) return 'Soon';
            return 'Active';
        }
        
        function renderHistoryCards() {
            let filtered=[...allPassports]; const term=dom.searchBar.value.toLowerCase(),filter=dom.filterExpiryEl.value;
            if(term)filtered=filtered.filter(p=>`${p.givenName||''} ${p.surname||''}`.toLowerCase().includes(term)||(p.tags||[]).join(' ').toLowerCase().includes(term));
            const now = new Date();
            if (filter === '6m') { const sixM = new Date(); sixM.setMonth(now.getMonth() + 6); filtered = filtered.filter(p => { const exp = new Date(p.dateOfExpiry); return !isNaN(exp) && exp > now && exp < sixM; }); }
            else if (filter === '1y') { const oneY = new Date(); oneY.setFullYear(now.getFullYear() + 1); filtered = filtered.filter(p => { const exp = new Date(p.dateOfExpiry); return !isNaN(exp) && exp > now && exp < oneY; }); }
            filtered.sort((a,b)=>{const sort=dom.sortByEl.value;if(sort==='createdAt')return new Date(b.createdAt)-new Date(a.createdAt);if(sort==='LastName')return(a.surname||'').localeCompare(b.surname||'');if(sort==='DateofExpiry')return new Date(a.dateOfExpiry)-new Date(b.dateOfExpiry);return 0;});
            dom.historyContainer.innerHTML='';
            if(allPassports.length === 0) dom.historyContainer.innerHTML = `<div class="text-center py-10 px-4"><svg class="mx-auto h-12 w-12 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7m-4 4h.01M7 11h.01M11 11h.01M15 11h.01M3 7l-2 4h22l-2-4M3 7l4-4M21 7l-4-4m-4 4l-2-4m4 4l2-4"/></svg><h3 class="mt-2 text-base font-medium">No Passports Saved</h3><p class="mt-1 text-sm text-[var(--text-secondary)]">Upload your first passport to get started.</p></div>`;
            else if(filtered.length === 0) dom.historyContainer.innerHTML = `<p class="text-center py-4">No records match your filter.</p>`;
            else filtered.forEach(p=>dom.historyContainer.appendChild(createHistoryCard(p)));
            updateDashboardHighlights();
        }
        
        function updateDashboardHighlights() {
            const filter = dom.filterExpiryEl.value, searchTerm = dom.searchBar.value;
            dom.dashboardTotal.classList.remove('active-dashboard-filter'); dom.dashboardExpiringSoon.classList.remove('active-dashboard-filter'); dom.dashboardExpiring6m.classList.remove('active-dashboard-filter');
            if (searchTerm) return; 
            if (filter === 'all') { dom.dashboardTotal.classList.add('active-dashboard-filter'); } 
            else if (filter === '1y') { dom.dashboardExpiringSoon.classList.add('active-dashboard-filter'); } 
            else if (filter === '6m') { dom.dashboardExpiring6m.classList.add('active-dashboard-filter'); }
        }
        
        function updateDashboardAnalytics() {
            document.getElementById('total-records').textContent = allPassports.length;
            const now=new Date(),oneYr=new Date();oneYr.setFullYear(now.getFullYear()+1);const sixMo=new Date();sixMo.setMonth(now.getMonth()+6);
            let soon=0,six=0;
            allPassports.forEach(p=>{const exp=new Date(p.dateOfExpiry);if(!isNaN(exp) && exp > now){if(exp<oneYr)soon++;if(exp<sixMo)six++;}});
            document.getElementById('expiring-soon').textContent=soon;
            document.getElementById('expiring-6m').textContent=six;
        }

        function checkAndDisplayExpiryWarning(expiryDateString, container) {
            const status=getExpiryStatus(expiryDateString);if(status==='Active')return;
            const isExpired=status==='Expired';
            const warning=document.createElement('div');warning.className=`p-3 ${isExpired?'bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 text-red-700 dark:text-red-300':'bg-yellow-100 dark:bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300'}`;
            warning.innerHTML=`<p class="font-bold">${isExpired?'Passport Expired':'Expiry Warning'}</p><p class="text-sm">${isExpired?`This passport expired on ${formatDateForDisplay(expiryDateString)}.`:`This passport expires soon: ${formatDateForDisplay(expiryDateString)}.`}</p>`;
            container.prepend(warning);
        }

        function exportToCSV() {
            if(allPassports.length===0){showToast("No records to export.","error");return;}
            const csvHeaders = passportFields.map(f => f.label);
            csvHeaders.push("Current Age", "Tags");

            const csvRows=[csvHeaders.join(',')];
            allPassports.forEach(p=>{
                const pWithAge = {...p, "age": calculateAge(p.dateOfBirth)};
                const row = passportFields.map(field => {
                    let value = pWithAge[field.key] || '';
                    if (field.key.toLowerCase().includes('date')) value = formatDateForDisplay(value);
                    return `"${value.toString().replace(/"/g, '""')}"`;
                });
                row.push(`"${pWithAge.age}"`);
                row.push(`"${(pWithAge.tags || []).join('; ')}"`);
                csvRows.push(row.join(','));
            });
            const blob=new Blob([csvRows.join('\n')],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a'),url=URL.createObjectURL(blob);
            link.setAttribute('href',url);link.setAttribute('download','passport_records.csv');link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);
        }

        function resetUI() { 
            dom.uploadContainer.classList.remove('hidden'); 
            dom.comparisonView.classList.add('hidden');
            dom.passportUpload.value=''; 
        }
        function displayError(message) { 
            const errorContainer = document.getElementById('extracted-data');
            errorContainer.innerHTML=`<p class="text-red-500 text-center">${message}</p>`;
            dom.comparisonView.classList.remove('hidden');
        }
    </script>
</body>
</html>
