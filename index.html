```html
<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passport Information Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script>
        // Set theme on initial load
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f7;
            --bg-tertiary: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --border-color: #d2d2d7;
            --accent-color: #007aff;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --btn-primary-bg: #007aff;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #e8e8ea;
            --btn-secondary-text: #1d1d1f;
        }

        .dark {
            --bg-primary: #1d1d1f;
            --bg-secondary: #000000;
            --bg-tertiary: #161617;
            --text-primary: #f5f5f7;
            --text-secondary: #86868b;
            --border-color: #3a3a3c;
            --accent-color: #0a84ff;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --btn-primary-bg: #0a84ff;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #2c2c2e;
            --btn-secondary-text: #f5f5f7;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .main-panel {
            background-color: var(--bg-tertiary);
            border-radius: 18px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        h2 { font-size: 1.75rem; font-weight: 600; color: var(--text-primary); }
        p { color: var(--text-secondary); }

        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 10px 18px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: transform 0.1s ease, background-color 0.2s ease, opacity 0.2s ease;
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary { background-color: var(--btn-primary-bg); color: var(--btn-primary-text); }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.1); }
        
        .btn-secondary { background-color: var(--btn-secondary-bg); color: var(--btn-secondary-text); }
        .btn-secondary:hover:not(:disabled) { filter: brightness(0.95); }
        .dark .btn-secondary:hover:not(:disabled) { filter: brightness(1.15); }

        .form-input, .form-select {
            width: 100%;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--text-primary);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px var(--accent-color-translucent, rgba(0, 122, 255, 0.2));
        }

        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .active-dashboard-filter { background-color: var(--btn-secondary-bg); }
        
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        .toast-in { animation: slideInRight 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .toast-out { animation: slideOutRight 0.5s cubic-bezier(0.5, 0, 0.75, 0) forwards; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-10">
            <div class="text-left">
                <h1 class="text-3xl md:text-4xl font-bold tracking-tighter text-[var(--text-primary)]">Travelverse Passport Extractor</h1>
                <p class="max-w-2xl mt-2">Upload a passport image to automatically extract and save traveler information.</p>
            </div>
             <div class="flex items-center gap-2">
                <button id="theme-toggle" type="button" class="w-10 h-10 flex-shrink-0 flex items-center justify-center rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50 focus:outline-none transition-colors">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zm7.536 2.464a1 1 0 01-1.414 0l-.707-.707a1 1 0 011.414-1.414l.707.707a1 1 0 010 1.414z"></path></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="main-panel p-6">
                <h2 class="text-2xl font-semibold mb-4">Upload Passport</h2>
                <div id="upload-container" class="border-2 border-dashed border-[var(--border-color)] rounded-lg p-8 text-center cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors">
                    <input type="file" id="passport-upload" class="hidden" accept=".pdf,.png,.jpeg,.jpg">
                    <svg class="mx-auto h-12 w-12 text-[var(--text-secondary)]" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                    <p class="mt-2 text-sm"><span class="font-medium text-[var(--accent-color)]">Click to upload</span> or drag and drop</p>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">PNG, JPG, JPEG, or PDF</p>
                </div>
                
                 <div id="loading-spinner" class="mt-6 hidden text-center"><div class="loader mx-auto"></div><p class="mt-4">Extracting information, please wait...</p></div>

                <div id="comparison-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 items-start">
                    <div><img id="image-preview" src="#" alt="Passport Preview" class="w-full rounded-lg shadow-md border border-[var(--border-color)]"></div>
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Extracted Information</h3>
                        <div id="extracted-data" class="space-y-3"></div>
                        <div class="mt-4">
                            <label for="tags-input" class="block text-sm font-medium mb-1">Tags (comma-separated)</label>
                            <input type="text" id="tags-input" placeholder="e.g. Family Trip, VIP" class="form-input text-sm">
                        </div>
                        <button id="save-button" class="btn btn-primary mt-6 w-full" disabled>
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 3.75H6.912a2.25 2.25 0 00-2.15 1.588L2.35 13.177a2.25 2.25 0 00-.1.661V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18v-4.162c0-.224-.034-.447-.1-.661L19.24 5.338A2.25 2.25 0 0017.088 3.75H15M12 3.75v9" /></svg>
                            <span id="save-button-text">Save Information</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="main-panel p-6">
                <h2 class="text-2xl font-semibold mb-4">Saved Records</h2>
                <div class="flex items-center space-x-2 md:space-x-4 mb-6 text-center">
                    <div id="dashboard-total" class="flex-1 p-2 rounded-lg cursor-pointer transition-colors"><p class="text-3xl font-bold" id="total-records">0</p><p class="text-sm">Total</p></div>
                    <div id="dashboard-expiring-soon" class="flex-1 p-2 rounded-lg cursor-pointer transition-colors"><p class="text-3xl font-bold text-yellow-500" id="expiring-soon">0</p><p class="text-sm">Expiring &lt; 1 Yr</p></div>
                    <div id="dashboard-expiring-6m" class="flex-1 p-2 rounded-lg cursor-pointer transition-colors"><p class="text-3xl font-bold text-red-500" id="expiring-6m">0</p><p class="text-sm">Expiring &lt; 6 Mo</p></div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div class="relative"><input type="text" id="search-bar" placeholder="Search by name or tag..." class="form-input pl-10"><svg class="w-5 h-5 text-[var(--text-secondary)] absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg></div>
                    <div class="grid grid-cols-2 gap-2">
                        <select id="sort-by" class="form-select"><option value="createdAt">Sort: Date Added</option><option value="LastName">Sort: Last Name</option><option value="DateofExpiry">Sort: Expiry</option></select>
                        <select id="filter-expiry" class="form-select">
                            <option value="all">Filter: All</option>
                            <option value="1y">Expiring &lt; 1 yr</option>
                            <option value="6m">Expiring &lt; 6 mo</option>
                        </select>
                    </div>
                </div>
                 <button id="export-csv" class="btn btn-secondary w-full mb-4"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v4.59L7.3 9.24a.75.75 0 00-1.1 1.02l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75z" clip-rule="evenodd" /></svg><span>Export All to CSV</span></button>
                <div id="history-container" class="space-y-4 max-h-[550px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>
    
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-60 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-2xl bg-[var(--bg-tertiary)]">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                <h3 class="text-lg leading-6 font-medium mt-2">Delete Record</h3>
                <div class="mt-2 px-7 py-3"><p class="text-sm">Are you sure? This action cannot be undone.</p></div>
                <div class="flex gap-2 items-center px-4 py-3">
                    <button id="cancel-delete-btn" class="btn btn-secondary w-full">Cancel</button>
                    <button id="confirm-delete-btn" class="btn btn-primary w-full bg-red-600 hover:bg-red-700">Delete</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <footer class="text-center py-8 text-sm text-[var(--text-secondary)]">
        <p>Intelligent travel system I Powered by Travelverse</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration for Standalone Deployment ---
        const firebaseConfig = {
          apiKey: "AIzaSyCtEzszro3KuPP__512HWj_8T16ElZUOAU",
          authDomain: "passport-technology-8ecfa.firebaseapp.com",
          projectId: "passport-technology-8ecfa",
          storageBucket: "passport-technology-8ecfa.firebasestorage.app",
          messagingSenderId: "834455244022",
          appId: "1:834455244022:web:ad7ba60cb7e1e38106b0d7",
          measurementId: "G-2RRTNRFWLF"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let extractedJson = null;
        let currentImageBase64Url = null;
        let allPassports = [];
        let dataListenerUnsubscribe = null; 

        // --- Helper functions for Date Formatting ---
        function formatDateForDisplay(isoDate) {
            if (!isoDate || isoDate === "N/A" || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return isoDate;
            const [y, m, d] = isoDate.split('-');
            return `${d}-${m}-${y}`;
        }

        function parseDateFromDisplay(displayDate) {
            if (!displayDate || displayDate === "N/A" || !/^\d{2}-\d{2}-\d{4}$/.test(displayDate)) return displayDate;
            const [d, m, y] = displayDate.split('-');
            return `${y}-${m}-${d}`;
        }
        
        // --- DOM Elements ---
        const dom = { 
            uploadContainer: document.getElementById('upload-container'), passportUpload: document.getElementById('passport-upload'), loadingSpinner: document.getElementById('loading-spinner'), 
            historyContainer: document.getElementById('history-container'), searchBar: document.getElementById('search-bar'), tagsInput: document.getElementById('tags-input'), 
            exportCsvButton: document.getElementById('export-csv'), sortByEl: document.getElementById('sort-by'), filterExpiryEl: document.getElementById('filter-expiry'), 
            deleteModal: document.getElementById('delete-modal'), confirmDeleteBtn: document.getElementById('confirm-delete-btn'), cancelDeleteBtn: document.getElementById('cancel-delete-btn'), 
            themeToggle: document.getElementById('theme-toggle'), darkIcon: document.getElementById('theme-toggle-dark-icon'), lightIcon: document.getElementById('theme-toggle-light-icon'), 
            comparisonView: document.getElementById('comparison-view'), imagePreview: document.getElementById('image-preview'), extractedDataEl: document.getElementById('extracted-data'), 
            saveButton: document.getElementById('save-button'),
            dashboardTotal: document.getElementById('dashboard-total'),
            dashboardExpiringSoon: document.getElementById('dashboard-expiring-soon'),
            dashboardExpiring6m: document.getElementById('dashboard-expiring-6m')
        };
        
        // --- Robust Authentication Flow ---
        function startApp() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("Authentication successful. User ID:", user.uid);
                    userId = user.uid;
                    if (dataListenerUnsubscribe) dataListenerUnsubscribe();
                    loadHistory();
                } else {
                    console.log("No user found. Attempting anonymous sign-in...");
                    signInAnonymously(auth).catch((error) => {
                        console.error("Anonymous sign-in failed:", error);
                        showToast('Authentication failed. Please check Firebase settings.', 'error');
                    });
                }
            });
        }
        
        // --- Event Listeners ---
        dom.uploadContainer.addEventListener('click', () => dom.passportUpload.click());
        ['dragover', 'dragleave', 'drop'].forEach(evt => dom.uploadContainer.addEventListener(evt, e => { e.preventDefault(); dom.uploadContainer.classList.toggle('bg-[var(--bg-secondary)]', evt === 'dragover'); if (evt === 'drop' && e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); }));
        dom.passportUpload.onchange = e => { if (e.target.files.length) handleFile(e.target.files[0]); };
        dom.saveButton.onclick = savePassportData;
        [dom.searchBar, dom.sortByEl, dom.filterExpiryEl].forEach(el => el.oninput = renderHistoryCards);
        dom.exportCsvButton.onclick = exportToCSV;
        dom.cancelDeleteBtn.onclick = () => dom.deleteModal.classList.add('hidden');
        dom.themeToggle.onclick = () => { localStorage.setItem('theme', document.documentElement.classList.toggle('dark') ? 'dark' : 'light'); updateThemeIcons(); };
        
        dom.dashboardTotal.onclick = () => { dom.filterExpiryEl.value = 'all'; dom.searchBar.value = ''; renderHistoryCards(); };
        dom.dashboardExpiringSoon.onclick = () => { dom.filterExpiryEl.value = '1y'; renderHistoryCards(); };
        dom.dashboardExpiring6m.onclick = () => { dom.filterExpiryEl.value = '6m'; renderHistoryCards(); };
        
        startApp();

        // --- UI & Theme ---
        function updateThemeIcons() { dom.darkIcon.classList.toggle('hidden', !document.documentElement.classList.contains('dark')); dom.lightIcon.classList.toggle('hidden', document.documentElement.classList.contains('dark')); }
        updateThemeIcons();
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `p-4 rounded-xl shadow-lg text-white ${colors} toast-in`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.replace('toast-in', 'toast-out'); toast.addEventListener('animationend', () => toast.remove()); }, 3000);
        }

        // --- File Handling and OCR ---
        async function handleFile(file) {
            resetUI(); 
            dom.uploadContainer.classList.add('hidden');
            let base64Data;
            if (file.type === 'application/pdf') {
                dom.loadingSpinner.classList.remove('hidden');
                const pdfData = await file.arrayBuffer(), pdf = await pdfjsLib.getDocument({ data: pdfData }).promise, page = await pdf.getPage(1), viewport = page.getViewport({ scale: 2.0 }), canvas = document.createElement('canvas'), ctx = canvas.getContext('2d');
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                currentImageBase64Url = canvas.toDataURL('image/jpeg'); base64Data = currentImageBase64Url.split(',')[1]; dom.imagePreview.src = currentImageBase64Url;
            } else {
                const reader = new FileReader();
                reader.onload = e => { currentImageBase64Url = e.target.result; dom.imagePreview.src = currentImageBase64Url; base64Data = currentImageBase64Url.split(',')[1]; extractData(base64Data, file.type); };
                reader.readAsDataURL(file);
            }
            if (base64Data) extractData(base64Data, 'image/jpeg');
        }
        
        async function extractData(base64ImageData, mimeType) {
            dom.loadingSpinner.classList.remove('hidden');
            const apiKey=firebaseConfig.apiKey;
            const model="gemini-1.5-flash-latest";
            const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const sysPrompt=`You are an expert OCR system for passports. Extract the following information and return it as a valid JSON object: Issuing Country Code, Passport No., Surname, Given Name, Nationality, Sex, Date of Birth, Place of Birth, Date of Issue, Date of Expiry. Crucially, all dates must be formatted as YYYY-MM-DD. If a field is not present, use "N/A".`;
            const payload={contents:[{parts:[{text:"Extract passport info."}, {inlineData:{mimeType, data:base64ImageData}}]}], systemInstruction:{parts:[{text:sysPrompt}]}, generationConfig:{responseMimeType:"application/json"}};
            try {
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await res.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    extractedJson = JSON.parse(result.candidates[0].content.parts[0].text);
                    displayExtractedData(extractedJson);
                } else { 
                    console.error("No data in Gemini response:", result); 
                    displayError("Failed to extract info."); 
                }
            } catch (e) { 
                console.error("Gemini API error:", e); 
                displayError("Error processing image."); 
            } 
            finally { 
                dom.loadingSpinner.classList.add('hidden'); 
            }
        }

        function displayExtractedData(data) {
            dom.extractedDataEl.innerHTML = '';
            checkAndDisplayExpiryWarning(data["Date of Expiry"], dom.extractedDataEl);
            const map = { "First Name": data["Given Name"], "Last Name": data["Surname"], "Passport No.": data["Passport No."], "Issuing Country Code": data["Issuing Country Code"], "Nationality": data["Nationality"], "Sex": data["Sex"], "Date of Birth": data["Date of Birth"], "Place of Birth": data["Place of Birth"], "Date of Issue": data["Date of Issue"], "Date of Expiry": data["Date of Expiry"] };
            for (const k in map) {
                let v = map[k] || "N/A";
                if (k.includes("Date")) {
                    v = formatDateForDisplay(v);
                }
                const div = document.createElement('div');
                div.innerHTML = `<label class="block text-xs font-medium text-[var(--text-secondary)]">${k}</label><input type="text" class="form-input mt-1 text-sm" value="${v}" data-key="${k}">`;
                dom.extractedDataEl.appendChild(div);
            }
            dom.comparisonView.classList.remove('hidden');
        }

        // --- Firestore Database Operations ---
        async function savePassportData() {
            if (!userId) { showToast("Cannot save: Connection not ready.", "error"); return; }
            if (!currentImageBase64Url) { showToast("Cannot save: No passport image is loaded.", "error"); return; }
            try {
                const dataToSave = { createdAt: new Date().toISOString(), imageData: currentImageBase64Url, lastUpdatedAt: new Date().toISOString() };
                dom.extractedDataEl.querySelectorAll('input').forEach(i => {
                    let value = i.value.trim() || "N/A";
                    if (i.dataset.key.includes("Date")) {
                        value = parseDateFromDisplay(value);
                    }
                    dataToSave[i.dataset.key] = value;
                });
                dataToSave.tags = dom.tagsInput.value.split(',').map(t => t.trim()).filter(Boolean);
                const pNo = dataToSave["Passport No."];
                if (pNo && pNo !== "N/A" && allPassports.some(p => p["Passport No."] == pNo)) {
                    showToast("A passport with this number already exists.", "error");
                    return;
                }
                await addDoc(collection(db, `users/${userId}/passports`), dataToSave);
                showToast("Information saved successfully!");
                setTimeout(resetUI, 1000);
            } catch (e) {
                console.error("Save error:", e);
                showToast("Failed to save. Network or server issue.", "error");
            }
        }

        function loadHistory() {
            if(!userId) return;
            const q = collection(db, `users/${userId}/passports`);
            dataListenerUnsubscribe = onSnapshot(q, snap => {
                allPassports = [];
                snap.forEach(d => allPassports.push({id: d.id, ...d.data()}));
                renderHistoryCards();
                updateDashboardAnalytics();
            }, (error) => {
                console.error("Error listening to data:", error);
            });
        }
        
        // --- Gemini LLM Call ---
        async function getTravelAssistance(prompt, resultContainer) {
            resultContainer.innerHTML = '<div class="flex justify-center items-center p-4"><div class="loader"></div></div>';
            const apiKey=firebaseConfig.apiKey;
            const model="gemini-1.5-flash-latest";
            const url=`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }], tools: [{ "google_search": {} }] };
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error(`API call failed with status: ${res.status}`);
                const result = await res.json();
                if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                    let formattedText = result.candidates[0].content.parts[0].text;
                    formattedText = formattedText
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/^(#{1,6}) (.*$)/gm, (m, h, c) => `<h${h.length+2}>${c}</h${h.length+2}>`).replace(/\n/g, '<br>');
                    resultContainer.innerHTML = formattedText;
                } else {
                    console.error("No valid response from Gemini:", result);
                    resultContainer.innerHTML = '<p class="text-red-500 text-sm">Sorry, I couldn\'t retrieve that information.</p>';
                }
            } catch (e) {
                console.error("Gemini API error:", e);
                resultContainer.innerHTML = `<p class="text-red-500 text-sm">An error occurred. Please check the console.</p>`;
            }
        }
        
        function createHistoryCard(data) {
            const card=document.createElement('div');
            card.className='bg-[var(--bg-tertiary)] p-4 rounded-xl border border-[var(--border-color)] space-y-3 passport-card shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300';
            card.dataset.docId=data.id;
            
            const status=getExpiryStatus(data["Date of Expiry"]);
            const statusClasses={Active:'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300',Soon:'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300',Expired:'bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300'};
            card.innerHTML=`<div class="flex justify-between items-start"><div class="font-semibold text-lg">${data["First Name"]||''} ${data["Last Name"]||''}</div><span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusClasses[status]}">${status}</span></div>`;

            const viewContainer=document.createElement('div');viewContainer.className='view-mode';
            viewContainer.innerHTML=`<div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">${createDetailItem('First Name',data["First Name"])}${createDetailItem('Last Name',data["Last Name"])}${createDetailItem('Passport No.',data["Passport No."])}${createDetailItem('Nationality',data["Nationality"])}${createDetailItem('Date of Birth',formatDateForDisplay(data["Date of Birth"]))}${createDetailItem('Place of Birth',data["Place of Birth"])}${createDetailItem('Date of Issue',formatDateForDisplay(data["Date of Issue"]))}${createDetailItem('Date of Expiry',formatDateForDisplay(data["Date of Expiry"]), (status==='Expired'?'text-red-500':status==='Soon'?'text-yellow-500':''))}</div>`;
            if(data.tags&&data.tags.length){const tagsContainer=document.createElement('div');tagsContainer.className='mt-2 flex flex-wrap gap-1.5';data.tags.forEach(t=>{const tagEl=document.createElement('span');tagEl.className='inline-block bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 px-2 py-0.5 rounded-full text-xs font-medium';tagEl.textContent=t;tagsContainer.appendChild(tagEl);});viewContainer.appendChild(tagsContainer);}

            const editContainer=document.createElement('div');editContainer.className='edit-mode hidden space-y-2';
            const fields=["First Name","Last Name","Passport No.","Nationality","Sex","Date of Birth","Place of Birth","Date of Issue","Date of Expiry","Issuing Country Code"];
            fields.forEach(f=>{
                let value = data[f] || '';
                if (f.includes("Date")) {
                    value = formatDateForDisplay(value);
                }
                editContainer.innerHTML+=`<div><label class="block text-xs font-medium text-[var(--text-secondary)]">${f}</label><input type="text" data-key="${f}" value="${value}" class="form-input text-sm mt-1"></div>`;
            });
            editContainer.innerHTML+=`<div><label class="block text-xs font-medium text-[var(--text-secondary)]">Tags</label><input type="text" data-key="tags" value="${(data.tags||[]).join(', ')}" class="form-input text-sm mt-1"></div>`;

            card.appendChild(viewContainer); card.appendChild(editContainer);
            
            const btnContainer=document.createElement('div');btnContainer.className='flex flex-wrap gap-2 pt-3 border-t border-[var(--border-color)]';
            const btns={preview:createButton('Preview','btn-secondary'),edit:createButton('Edit','btn-secondary edit-btn'),del:createButton('Delete','btn-secondary delete-btn'),ai:createButton('✨ AI Assistant','btn-secondary'),save:createButton('Save','btn-primary save-changes-btn hidden'),cancel:createButton('Cancel','btn-secondary cancel-btn hidden')};
            btnContainer.append(btns.preview,btns.edit,btns.del,btns.ai,btns.save,btns.cancel);
            
            const imgContainer=document.createElement('div');imgContainer.className='hidden mt-4';
            if(data.imageData){imgContainer.innerHTML=`<img src="${data.imageData}" alt="Passport Preview" class="w-full h-auto rounded-md shadow border border-[var(--border-color)]">`;btns.preview.onclick=()=>{const isHidden=imgContainer.classList.toggle('hidden');btns.preview.textContent=isHidden?'Show Preview':'Hide Preview';};}else{btns.preview.disabled=true;btns.preview.textContent='No Preview';}
            
            const aiContainer = document.createElement('div');aiContainer.className = 'hidden mt-4 pt-4 border-t border-[var(--border-color)] space-y-3';
            const destinationInput = document.createElement('input');destinationInput.type = 'text';destinationInput.placeholder = 'Enter Destination Country';destinationInput.className = 'form-input text-sm';
            const aiButtons = document.createElement('div');aiButtons.className = 'grid grid-cols-2 gap-2';
            const visaBtn = createButton('Check Visa', 'btn-secondary');const checklistBtn = createButton('Get Checklist', 'btn-secondary');aiButtons.append(visaBtn, checklistBtn);
            const aiResult = document.createElement('div');aiResult.className = 'mt-2 p-3 rounded-lg bg-[var(--bg-secondary)] text-sm prose dark:prose-invert max-w-none';aiResult.innerHTML = '<p class="text-xs text-[var(--text-secondary)]">Enter a destination to get AI-powered travel assistance.</p>';
            aiContainer.append(destinationInput, aiButtons, aiResult);
            btns.ai.onclick = () => aiContainer.classList.toggle('hidden');

            visaBtn.onclick = () => { const dest = destinationInput.value.trim(); if (!dest) { showToast('Please enter a destination.', 'error'); return; } getTravelAssistance(`Tourist visa requirements for a citizen from '${data.Nationality}' traveling to '${dest}'? Provide a concise summary.`, aiResult); };
            checklistBtn.onclick = () => { const dest = destinationInput.value.trim(); if (!dest) { showToast('Please enter a destination.', 'error'); return; } getTravelAssistance(`Create a comprehensive pre-travel checklist for a tourist from '${data.Nationality}' traveling to '${dest}'. Use markdown for formatting.`, aiResult); };

            card.appendChild(btnContainer); card.appendChild(imgContainer); card.appendChild(aiContainer);

            btns.edit.onclick=()=>{[viewContainer,btns.edit,btns.del,btns.preview,btns.ai].forEach(el=>el.classList.add('hidden'));[editContainer,btns.save,btns.cancel].forEach(el=>el.classList.remove('hidden'));};
            btns.cancel.onclick=()=>{[viewContainer,btns.edit,btns.del,btns.preview,btns.ai].forEach(el=>el.classList.remove('hidden'));[editContainer,btns.save,btns.cancel].forEach(el=>el.classList.add('hidden'));};
            btns.save.onclick=async()=>{
                const updatedData={lastUpdatedAt:new Date().toISOString()};
                editContainer.querySelectorAll('input').forEach(i=>{
                    if(i.dataset.key==='tags') updatedData.tags=i.value.split(',').map(t=>t.trim()).filter(Boolean);
                    else if(i.dataset.key.includes("Date")) updatedData[i.dataset.key] = parseDateFromDisplay(i.value);
                    else updatedData[i.dataset.key]=i.value;
                });
                await updateDoc(doc(db,`users/${userId}/passports`,data.id),updatedData);showToast('Record updated!');
            };
            btns.del.onclick=()=>{dom.deleteModal.classList.remove('hidden');dom.confirmDeleteBtn.onclick=async()=>{await deleteDoc(doc(db,`users/${userId}/passports`,data.id));dom.deleteModal.classList.add('hidden');showToast('Record deleted.','error');};};
            return card;
        }

        // --- UI Helper Functions ---
        function createDetailItem(label, value, valueClass = '') { return `<div><div class="text-xs text-[var(--text-secondary)]">${label}</div><div class="text-[var(--text-primary)] font-medium ${valueClass}">${value || 'N/A'}</div></div>`; }
        function createButton(text, className) { const btn=document.createElement('button');btn.className=`btn text-sm flex-1 ${className}`;btn.textContent=text; return btn; }
        
        function getExpiryStatus(expiryDateString) {
            if(!expiryDateString||expiryDateString==="N/A")return'Active';const expiryDate=new Date(expiryDateString),now=new Date(),oneYearFromNow=new Date();oneYearFromNow.setFullYear(now.getFullYear()+1);
            if(isNaN(expiryDate))return'Active';if(expiryDate<now)return'Expired';if(expiryDate<oneYearFromNow)return'Soon';return'Active';
        }
        
        function renderHistoryCards() {
            let filtered=[...allPassports]; const term=dom.searchBar.value.toLowerCase(),filter=dom.filterExpiryEl.value;
            if(term)filtered=filtered.filter(p=>`${p["First Name"]||''} ${p["Last Name"]||''}`.toLowerCase().includes(term)||(p.tags||[]).join(' ').toLowerCase().includes(term));
            
            const now = new Date();
            if (filter === '6m') { const sixM = new Date(); sixM.setMonth(now.getMonth() + 6); filtered = filtered.filter(p => { const exp = new Date(p["Date of Expiry"]); return !isNaN(exp) && exp > now && exp < sixM; }); }
            else if (filter === '1y') { const oneY = new Date(); oneY.setFullYear(now.getFullYear() + 1); filtered = filtered.filter(p => { const exp = new Date(p["Date of Expiry"]); return !isNaN(exp) && exp > now && exp < oneY; }); }

            filtered.sort((a,b)=>{const sort=dom.sortByEl.value;if(sort==='createdAt')return new Date(b.createdAt)-new Date(a.createdAt);if(sort==='LastName')return(a["Last Name"]||'').localeCompare(b["Last Name"]||'');if(sort==='DateofExpiry')return new Date(a["Date of Expiry"])-new Date(b["Date of Expiry"]);return 0;});
            dom.historyContainer.innerHTML='';
            if(allPassports.length === 0) dom.historyContainer.innerHTML = `<div class="text-center py-10 px-4"><svg class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 11c0 3.517-1.009 6.789-2.756 9.348m-2.28-2.28A9.961 9.961 0 0112 11c0-5.523 4.477-10 10-10 4.386 0 8.217 2.783 9.575 6.75M12 11c-3.517 0-6.789-1.009-9.348-2.756m2.28 2.28A9.961 9.961 0 0112 11z"/></svg><h3 class="mt-2 text-lg font-medium">No Passports Saved</h3><p class="mt-1 text-sm">Upload your first passport to get started.</p></div>`;
            else if(filtered.length === 0) dom.historyContainer.innerHTML = `<p class="text-center py-4">No records match your filter.</p>`;
            else filtered.forEach(p=>dom.historyContainer.appendChild(createHistoryCard(p)));

            updateDashboardHighlights();
        }
        
        function updateDashboardHighlights() {
            const filter = dom.filterExpiryEl.value, searchTerm = dom.searchBar.value;
            dom.dashboardTotal.classList.remove('active-dashboard-filter'); dom.dashboardExpiringSoon.classList.remove('active-dashboard-filter'); dom.dashboardExpiring6m.classList.remove('active-dashboard-filter');
            if (searchTerm) return; 
            if (filter === 'all') { dom.dashboardTotal.classList.add('active-dashboard-filter'); } 
            else if (filter === '1y') { dom.dashboardExpiringSoon.classList.add('active-dashboard-filter'); } 
            else if (filter === '6m') { dom.dashboardExpiring6m.classList.add('active-dashboard-filter'); }
        }
        
        function updateDashboardAnalytics() {
            document.getElementById('total-records').textContent = allPassports.length;
            const now=new Date(),oneYr=new Date();oneYr.setFullYear(now.getFullYear()+1);const sixMo=new Date();sixMo.setMonth(now.getMonth()+6);
            let soon=0,six=0;
            allPassports.forEach(p=>{const exp=new Date(p["Date of Expiry"]);if(!isNaN(exp) && exp > now){if(exp<oneYr)soon++;if(exp<sixMo)six++;}});
            document.getElementById('expiring-soon').textContent=soon;
            document.getElementById('expiring-6m').textContent=six;
        }

        function checkAndDisplayExpiryWarning(expiryDateString, container) {
            const status=getExpiryStatus(expiryDateString);if(status==='Active')return;
            const expiryDate=new Date(expiryDateString);const isExpired=status==='Expired';
            const warning=document.createElement('div');warning.className=`p-3 rounded-lg mb-4 ${isExpired?'bg-red-100 dark:bg-red-900/50 border-l-4 border-red-500 text-red-700 dark:text-red-300':'bg-yellow-100 dark:bg-yellow-900/50 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300'}`;
            warning.innerHTML=`<p class="font-bold">${isExpired?'Passport Expired':'Expiry Warning'}</p><p class="text-sm">${isExpired?`This passport expired on ${formatDateForDisplay(expiryDateString)}.`:`This passport expires soon: ${formatDateForDisplay(expiryDateString)}.`}</p>`;
            container.prepend(warning);
        }

        function exportToCSV() {
            if(allPassports.length===0){showToast("No records to export.","error");return;}
            const headers=["First Name","Last Name","Passport No.","Issuing Country Code","Nationality","Sex","Date of Birth","Place of Birth","Date of Issue","Date of Expiry","Tags"];
            const csvRows=[headers.join(',')];
            allPassports.forEach(p=>{const row=headers.map(h=>{let v=p[h]||'';if(h.includes('Date'))v=formatDateForDisplay(v);if(h==='Tags')v=(p.tags||[]).join('; ');return`"${v.toString().replace(/"/g,'""')}"`;});csvRows.push(row.join(','));});
            const blob=new Blob([csvRows.join('\n')],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a'),url=URL.createObjectURL(blob);
            link.setAttribute('href',url);link.setAttribute('download','passport_records.csv');link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);
        }

        function resetUI() { 
            dom.passportUpload.value=''; dom.uploadContainer.classList.remove('hidden'); dom.comparisonView.classList.add('hidden');
            dom.imagePreview.src='#'; dom.loadingSpinner.classList.add('hidden'); dom.extractedDataEl.innerHTML=''; dom.tagsInput.value='';
            extractedJson=null; currentImageBase64Url=null;
        }
        function displayError(message) { 
            dom.extractedDataEl.innerHTML=`<p class="text-red-500 text-center">${message}</p>`;
            dom.comparisonView.classList.remove('hidden');
        }
    </script>
</body>
</html>
```
